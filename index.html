import React, { useEffect, useRef, useState } from "react";
import { Html5QrcodeScanner } from "html5-qrcode";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { motion } from "framer-motion";

// --------------------------------------------------
// QR â†’ Spotify Auto Player
// --------------------------------------------------
// Flow:
// 1. Scan QR code
// 2. Extract Spotify link
// 3. Auto play via Spotify embed
// 4. Button: Next song â†’ scan new QR
//
// Install:
// npm install html5-qrcode framer-motion
// --------------------------------------------------

export default function QRSpotifyPlayer() {
  const [spotifyUrl, setSpotifyUrl] = useState(null);
  const [scanning, setScanning] = useState(true);
  const scannerRef = useRef(null);

  useEffect(() => {
    if (!scanning) return;

    const scanner = new Html5QrcodeScanner("qr-reader", {
      fps: 10,
      qrbox: 250
    });

    scanner.render(
      (decodedText) => {
        if (decodedText.includes("spotify.com")) {
          setSpotifyUrl(convertToEmbed(decodedText));
          setScanning(false);
          scanner.clear();
        }
      },
      (error) => {}
    );

    scannerRef.current = scanner;

    return () => {
      scanner.clear().catch(() => {});
    };
  }, [scanning]);

  function convertToEmbed(url) {
    return url.replace("open.spotify.com", "open.spotify.com/embed");
  }

  function nextSong() {
    setSpotifyUrl(null);
    setScanning(true);
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-700 via-purple-600 to-pink-600 flex items-center justify-center p-4">
      <motion.div
        initial={{ scale: 0.9, opacity: 0 }}
        animate={{ scale: 1, opacity: 1 }}
        className="w-full max-w-md"
      >
        <Card className="rounded-2xl shadow-xl">
          <CardContent className="p-6 space-y-4">
            <h1 className="text-2xl font-bold text-center">ðŸ“¸ Scan & Play</h1>

            {scanning && (
              <div id="qr-reader" className="w-full rounded-xl overflow-hidden" />
            )}

            {spotifyUrl && (
              <>
                <iframe
                  src={spotifyUrl}
                  width="100%"
                  height="380"
                  frameBorder="0"
                  allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                  loading="lazy"
                  className="rounded-xl"
                />

                <Button className="w-full" onClick={nextSong}>
                  Volgend liedje âžœ scan nieuwe QR
                </Button>
              </>
            )}

            <p className="text-xs text-center opacity-60">
              Werkt met elke Spotify QR code of link
            </p>
          </CardContent>
        </Card>
      </motion.div>
    </div>
  );
}
