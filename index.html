import React, { useState, useEffect } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { motion } from "framer-motion";

// --------------------------------------------------
// Hitster Clone + Spotify Preview Integration
// --------------------------------------------------
// Requirements:
// 1. Spotify Developer Account
// 2. Create app: https://developer.spotify.com/dashboard
// 3. Add redirect URI: http://localhost:5173
// 4. Put your CLIENT_ID below
// --------------------------------------------------

const CLIENT_ID = "VUL_HIER_JE_SPOTIFY_CLIENT_ID_IN";
const REDIRECT_URI = "http://localhost:5173";
const AUTH_ENDPOINT = "https://accounts.spotify.com/authorize";
const RESPONSE_TYPE = "token";

export default function HitsterSpotifyClone() {
  const [token, setToken] = useState("");
  const [track, setTrack] = useState(null);
  const [guess, setGuess] = useState("");
  const [result, setResult] = useState(null);
  const [score, setScore] = useState(0);

  useEffect(() => {
    const hash = window.location.hash;
    let storedToken = window.localStorage.getItem("token");

    if (!storedToken && hash) {
      storedToken = hash
        .substring(1)
        .split("&")
        .find(elem => elem.startsWith("access_token"))
        .split("=")[1];

      window.location.hash = "";
      window.localStorage.setItem("token", storedToken);
    }

    setToken(storedToken);
  }, []);

  async function fetchTrack() {
    const res = await fetch("https://api.spotify.com/v1/recommendations?limit=1&seed_genres=pop,rock,dance", {
      headers: {
        Authorization: `Bearer ${token}`
      }
    });

    const data = await res.json();
    const t = data.tracks[0];

    setTrack({
      title: t.name,
      artist: t.artists[0].name,
      year: t.album.release_date.substring(0, 4),
      preview: t.preview_url
    });

    setGuess("");
    setResult(null);
  }

  function checkAnswer() {
    const diff = Math.abs(parseInt(guess) - parseInt(track.year));

    if (diff === 0) {
      setResult("Perfect! üéØ +3");
      setScore(s => s + 3);
    } else if (diff <= 2) {
      setResult("Bijna! ‚ö° +1");
      setScore(s => s + 1);
    } else {
      setResult(`Fout ‚ùå Het juiste jaar was ${track.year}`);
    }
  }

  if (!token) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-700 to-pink-600">
        <a
          className="px-6 py-3 bg-black text-white rounded-xl text-lg"
          href={`${AUTH_ENDPOINT}?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=${RESPONSE_TYPE}`}
        >
          Login met Spotify
        </a>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-700 via-purple-600 to-pink-600 flex items-center justify-center p-4">
      <motion.div initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }} className="w-full max-w-md">
        <Card className="rounded-2xl shadow-xl">
          <CardContent className="p-6 space-y-4">
            <h1 className="text-2xl font-bold text-center">üéµ Hitster Spotify</h1>

            {!track ? (
              <Button className="w-full" onClick={fetchTrack}>Start ronde</Button>
            ) : (
              <>
                <div className="text-center">
                  <div className="text-lg font-semibold">{track.title}</div>
                  <div className="text-sm opacity-70">{track.artist}</div>
                </div>

                {track.preview && (
                  <audio controls className="w-full">
                    <source src={track.preview} type="audio/mpeg" />
                  </audio>
                )}

                <Input
                  type="number"
                  placeholder="Raad het jaar"
                  value={guess}
                  onChange={e => setGuess(e.target.value)}
                />

                <Button className="w-full" onClick={checkAnswer}>Controleer</Button>

                {result && <div className="text-center font-semibold">{result}</div>}

                <div className="flex justify-between">
                  <div>Score: <b>{score}</b></div>
                  <Button variant="secondary" onClick={fetchTrack}>Volgende</Button>
                </div>
              </>
            )}
          </CardContent>
        </Card>
      </motion.div>
    </div>
  );
}
